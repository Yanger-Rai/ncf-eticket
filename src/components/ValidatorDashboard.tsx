"use client";
import React, { useState, useMemo } from "react";
import { createClient } from "@/lib/supabase/client";
import ConfirmationDialog from "./ConfirmationDialog";
import { Ticket, User, TicketStatus } from "@/types/types";
import StatusBadge from "./StatusBadge";

interface ValidatorDashboardProps {
  user: User;
  tickets: Ticket[];
  onUpdateTicketStatus: (ticketId: string, status: TicketStatus) => void;
}

interface TicketListProps {
  ticketList: Ticket[];
  onRedeem: (ticket: Ticket) => void;
  redeemingTicketId: string | null;
}

export default function ValidatorDashboard({
  user,
  tickets,
  onUpdateTicketStatus,
}: ValidatorDashboardProps) {
  const supabase = createClient();
  const [searchTerm, setSearchTerm] = useState<string>("");
  const [showConfirm, setShowConfirm] = useState<Ticket | null>(null);
  const [isDownloading, setIsDownloading] = useState(false);
  const [redeemingTicketId, setRedeemingTicketId] = useState<string | null>(
    null
  );

  const filteredTickets = useMemo(() => {
    if (!searchTerm.trim()) return tickets;
    const lowerCaseSearch = searchTerm.toLowerCase();
    return tickets.filter(
      (t) =>
        t.id.toLowerCase().includes(lowerCaseSearch) ||
        t.purchaser_name.toLowerCase().includes(lowerCaseSearch) ||
        t.generated_by_name.toLowerCase().includes(lowerCaseSearch)
    );
  }, [searchTerm, tickets]);

  const handleRedeem = async (ticketId: string) => {
    setRedeemingTicketId(ticketId);
    const { error } = await supabase
      .from("tickets")
      .update({ status: "REDEEMED" })
      .eq("id", ticketId);

    if (!error) {
      onUpdateTicketStatus(ticketId, "REDEEMED");
    }

    setShowConfirm(null);
    setRedeemingTicketId(null);
  };

  const handleDownloadReport = async () => {
    setIsDownloading(true);
    try {
      const { data: allTickets, error } = await supabase
        .from("tickets")
        .select("*")
        .order("purchase_date", { ascending: false });

      if (error) {
        throw error;
      }

      const headers = [
        "ID",
        "Purchaser Name",
        "Purchase Date",
        "Status",
        "Generated By",
        "Ticket Type",
        "Price",
      ];
      const csvRows = [
        headers.join(","),
        ...(allTickets || []).map((t) =>
          [
            t.id,
            `"${t.purchaser_name}"`,
            `"${new Date(t.purchase_date).toLocaleString()}"`,
            t.status,
            `"${t.generated_by_name}"`,
            t.ticket_type,
            t.price,
          ].join(",")
        ),
      ];

      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "naga_food_fest_report.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error("Error downloading report:", error);
      alert("Failed to download the report. Please try again.");
    } finally {
      setIsDownloading(false);
    }
  };

  const TicketList = ({
    ticketList,
    onRedeem,
    redeemingTicketId,
  }: TicketListProps) => (
    <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
      {ticketList.map((ticket) => (
        <div
          key={ticket.id}
          className="bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"
        >
          <div className="flex-1">
            <p className="font-extrabold text-xl text-gray-900">{ticket.id}</p>
            <p className="text-gray-800 text-lg">
              Purchaser:{" "}
              <span className="font-semibold">{ticket.purchaser_name}</span>
            </p>
            <p className="text-gray-600">
              Seller:{" "}
              <span className="font-semibold">{ticket.generated_by_name}</span>
            </p>
            <p className="text-xs text-gray-500">
              Purchased: {new Date(ticket.purchase_date).toLocaleString()}
            </p>
          </div>
          <div className="flex flex-col items-stretch sm:items-end gap-3 w-full sm:w-auto">
            <StatusBadge status={ticket.status} />
            {ticket.status === "VALID" && (
              <button
                onClick={() => onRedeem(ticket)}
                disabled={redeemingTicketId === ticket.id}
                className="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 shadow-lg disabled:bg-green-300"
              >
                {redeemingTicketId === ticket.id ? "Redeeming..." : "REDEEM"}
              </button>
            )}
          </div>
        </div>
      ))}
    </div>
  );

  return (
    <div className="p-4 space-y-6">
      <div className="bg-white p-6 rounded-xl shadow-lg">
        <h2 className="text-2xl font-bold text-gray-800 mb-4">
          Validate Tickets
        </h2>
        <input
          type="text"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg"
          placeholder="Search by ID, Purchaser, or Seller..."
        />
        {user.role === "admin" && (
          <div className="mt-4 text-center">
            <button
              onClick={handleDownloadReport}
              disabled={isDownloading}
              className="inline-flex items-center gap-2 px-6 py-2 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 disabled:bg-gray-400"
            >
              {isDownloading ? "Downloading..." : "Download Full Report"}
            </button>
          </div>
        )}
      </div>

      <div className="bg-white p-6 rounded-xl shadow-lg">
        <h3 className="text-xl font-bold text-gray-700 mb-3">
          {searchTerm
            ? `Search Results (${filteredTickets.length})`
            : `Recent Tickets (${filteredTickets.length})`}
        </h3>
        <TicketList
          ticketList={filteredTickets}
          onRedeem={setShowConfirm}
          redeemingTicketId={redeemingTicketId}
        />
      </div>

      {showConfirm && (
        <ConfirmationDialog
          message={`Confirm redemption for ticket ${showConfirm.id}?`}
          onConfirm={() => handleRedeem(showConfirm.id)}
          onCancel={() => setShowConfirm(null)}
        />
      )}
    </div>
  );
}
